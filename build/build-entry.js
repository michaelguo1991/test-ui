const path = require('path');
const fs = require('fs');
const upperCamelCase = require('uppercamelcase');
const render = require('json-templater/string');
const endOfLine = require('os').EOL;

//组件文件夹名称列表
const dirNames = fs.readdirSync(path.join(__dirname, '../packages'));

//import语句部分
const importSection = dirNames.reduce((accumulator, dirName) => {
    accumulator.push(`import ${upperCamelCase(dirName)} from '../packages/${dirName}'`);
    return accumulator;
}, []);

//组件列表
const components = dirNames.reduce((accumulator, dirName) => {
    accumulator.push(`    ${upperCamelCase(dirName)}`);
    return accumulator;
}, []);

//入口文件模板
const entryTemplate = `/* Automatically generated by '../build/build-entry.js' */

{{importSection}}

const components = [
{{components}}
];

const install = Vue => {
    components.forEach(component =>  {
        Vue.component(component.name, component);
    })
};

export default {
    install,
{{components}}
}
`;

const entryContent = render(entryTemplate, {
    importSection: importSection.join(endOfLine),
    components: components.join(`,${endOfLine}`)
})

const entryFilePath = path.join(__dirname, '../src/index.js');
fs.writeFileSync(entryFilePath, entryContent);
console.log('[Build Entry] Done: ', entryFilePath);